version: 0.2

env:
  variables:
    PACKER_VERSION: "1.9.4"
    BASE_AMI_PARAM_NAME: "/ami/base"
    NEW_AMI_PARAM_NAME: "/ami/application"
    REGION: "us-east-1"
  parameter-store:
    BASE_AMI: "/ami/base"

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "Installing Packer version ${PACKER_VERSION}"
      - curl -o packer.zip "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip"
      - unzip packer.zip -d /usr/local/bin/
      - chmod +x /usr/local/bin/packer
      - packer --version
      - npm install -g yarn
      
  pre_build:
    commands:
      - echo "Retrieving base AMI from Parameter Store"
      - echo "Base AMI ID: ${BASE_AMI}"
      - echo "Installing application dependencies"
      - yarn install
      
  build:
    commands:
      - echo "Building the application"
      - yarn build
      - echo "Creating Packer template"
      - echo '{' > packer-template.json
      - echo '  "variables": {' >> packer-template.json
      - echo '    "base_ami": "{{env `BASE_AMI`}}",
      - echo '    "region": "{{env `REGION`}}",
      - echo '    "app_version": "{{env `CODEBUILD_RESOLVED_SOURCE_VERSION`}}"' >> packer-template.json
      - echo '  },' >> packer-template.json
      - echo '  "builders": [{' >> packer-template.json
      - echo '    "type": "amazon-ebs",' >> packer-template.json
      - echo '    "region": "{{user `region`}}",' >> packer-template.json
      - echo '    "source_ami": "{{user `base_ami`}}",' >> packer-template.json
      - echo '    "instance_type": "t3.medium",' >> packer-template.json
      - echo '    "ssh_username": "ec2-user",' >> packer-template.json
      - echo '    "ami_name": "app-ami-{{user `app_version`}}-{{timestamp}}",' >> packer-template.json
      - echo '    "tags": {' >> packer-template.json
      - echo '      "Name": "AppAMI",' >> packer-template.json
      - echo '      "Version": "{{user `app_version`}}",' >> packer-template.json
      - echo '      "BuildId": "{{env `CODEBUILD_BUILD_ID`}}"' >> packer-template.json
      - echo '    }' >> packer-template.json
      - echo '  }],' >> packer-template.json
      - echo '  "provisioners": [' >> packer-template.json
      - echo '    {' >> packer-template.json
      - echo '      "type": "file",' >> packer-template.json
      - echo '      "source": "./dist",' >> packer-template.json
      - echo '      "destination": "/tmp/app"' >> packer-template.json
      - echo '    },' >> packer-template.json
      - echo '    {' >> packer-template.json
      - echo '      "type": "shell",' >> packer-template.json
      - echo '      "inline": [' >> packer-template.json
      - echo '        "sudo mkdir -p /var/www/app",' >> packer-template.json
      - echo '        "sudo cp -R /tmp/app/* /var/www/app/",' >> packer-template.json
      - echo '        "sudo chown -R ec2-user:ec2-user /var/www/app"' >> packer-template.json
      - echo '      ]' >> packer-template.json
      - echo '    }' >> packer-template.json
      - echo '  ]' >> packer-template.json
      - echo '}' >> packer-template.json
      - echo "Building AMI with Packer"
      - packer build -machine-readable packer-template.json > packer_output.txt
      - AMI_ID=$(cat packer_output.txt | grep 'artifact,0,id' | cut -d, -f6 | cut -d: -f2)
      - echo "Created AMI: ${AMI_ID}"
      
  post_build:
    commands:
      - echo "Storing new AMI ID in Parameter Store"
      - aws ssm put-parameter --name ${NEW_AMI_PARAM_NAME} --value ${AMI_ID} --type String --overwrite --region ${REGION}
      - echo "Build completed successfully!"

artifacts:
  files:
    - appspec.yml
    - dist/**/*
    - manifest.json
  discard-paths: no

cache:
  paths:
    - 'node_modules/**/*'
